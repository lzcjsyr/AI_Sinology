# 业务需求文档 (Product Requirements Document - PRD)

## 1. 项目背景与目标

本项目旨在开发一个基于多智能体系统（Multi-Agent System）的自动化程序，辅助中文系及相关人文学科的专业研究者高效撰写学术论文。
传统的论文撰写流程对文献梳理、原始史料的搜集和考据要求极高，耗时巨大。本项目通过引入 DSPy 驱动的多智能体协作框架，在确保学术严谨性的前提下（“无一字无来历”），极大提升选题构思、史料筛选、大纲编排、初稿撰写和后期润色的效率。

## 2. 核心用户工作流与功能模块

系统为纯命令行（CLI）交互界面，避免图形化干扰，核心阶段产物原则上以明确的序号存放在独立的 `outputs/` 项目文件夹下（内部缓存及状态标记除外）。为了提供极客且流畅的无状态交互体验，系统必须实现基于文件系统探针的智能工作流管理：

### 2.1 项目初始化与流转控制

1. **统一入口**：用户在终端输入 `python main.py` 启动程序。
2. **模式选择**：系统拦截指令并打印交互菜单：
   - `[1] 创建新研究项目`
   - `[2] 继续现有项目`
3. **断点续传智能推断**：若用户选择继续旧项目，系统自动扫描 `outputs/` 目录。通过探查特定项目文件夹内已生成的最高阶段文件（如发现 `3_outline_matrix.json`），系统能自动推断出该项目当前处于第四阶段（撰写初稿），并直接提示用户是否接续执行。

### 2.2 核心业务阶段流水线

核心流程分为以下五个阶段：

#### 阶段一：选题与构思 (Topic Selection & Conception)

- **目标**：根据用户模糊的研究意向，确立具备学术价值和可行性的研讨问题。
- **Agent角色**：选题顾问智能体 (Topic Advisor Agent)。调用外部学术文献 API 梳理前沿数据。（现阶段不需要外部API，纯内部完成)
- **用户交互**：输入一个想法（如“研究晚明通俗小说中的商人形象”），系统进行多轮推演。
- **关键产出**：5000字的《研究计划书》及目标主题检索列表。

#### 阶段二：史料搜集与交叉验证 (Data Collection & Cross-Validation)

- **目标**：对经典文本或文献库进行并发穷举式阅读，利用多模型交叉验证完成粗筛，确保史料引用的绝对可靠。
- **Agent角色**：多模型并发史料挖掘智能体 (Multi-LLM Archival Digger Agent)。两个模型独立筛查，第三个模型核验争议。
- **前置步骤（异构数据接入）**：将类似 `data/kanripo_repos` 等不同格式的古代典籍转换为统一的标准化片段。此处的切分颗粒度需以文本内置的 `<pb:...>`（Page Break）翻页标记或子节标记作为天然边界进行微观切分，`piece_id` 将直接提取并使用这些包含绝对学术语义的引文坐标（如 `pb:KR1a0001_tls_001-1a`），确保 LLM 每次吞吐的不仅是微小段落，且天生具备符合学术界习惯的（卷号、页码）防伪追溯坐标。
- **用户交互**：
  1. **检索范围选择 (Scope Selection)**：在 CLI 界面或总控调度阶段，系统允许用户限定检索范围。如果是 Kanripo 语料，系统启动时可输出形如 `[ ] KR1a 易類`, `[ ] KR1b 書類` 的互动列表供用户直接勾选（Checkbox 取值）。
  2. **细粒度自定义输入**：用户也可以跳过菜单框，直接手动键入具体的底层古籍文件夹名称（如 `KR1a0001`）。
  3. 范围选定后，先由纯代码的解析脚本（如 `parse_kanripo.py`）将所选原著转化为标准的碎片格式提取至临时池，不涉及任何大模型参与。随后再由筛选脚本（如 `archival_screening.py`）异步呼叫大语言模型进行高并发阅读初筛打分。最后再通过纯代码逻辑将原拼装合并产出可信度极高的史料卡片。
- **关键产出**：结构化的核心史料总库 `2_final_corpus.yaml`。

#### 阶段三：大纲构建与逻辑推演 (Outlining)

- **目标**：通过沙盘推演构建三级论文大纲，明确每一处史料在论述网络中的锚点。
- **Agent角色**：大纲架构智能体 (Architect Agent)。审查结构漏洞并组织骨架。
- **关键产出**：《三级论纲与逻辑推演表》（大纲中的底层论据节点必须直接绑定前一阶段搜集到的具体史料片段唯一标识符 `piece_id`，以彻底杜绝大模型凭空捏造论据）。

#### 阶段四：撰写初稿 (Drafting)

- **目标**：在严密的 RAG（检索增强生成）模式下，根据大纲将史料翻译出合理的分析性文字，写出初稿。
- **Agent角色**：写作执行智能体 (Writer Agent)。严格依照输入的小观点与史料片段推演，禁止凭空捏造。
- **关键产出**：《论文初稿》含有基本的引注区。

#### 阶段五：修改与润色 (Revision & Polishing)

- **目标**：规范引用格式及文法，符合学术文体，排版达标。
- **Agent角色**：审稿与校对智能体 (Reviewer Agent)。引文查纠、语体转化、排版脚注生成。
- **关键产出**：符合学术期刊或学位论文规范、经过严格排版优化的终稿定稿（`.docx` 格式）及自检清单。

## 3. 非功能性需求

- **隔离性**：所有的不同研究项目拥有单独的 `outputs/` 隔离文件夹。
- **并发与限流**：在大量吞吐文献时，系统能够有效处理各 API 的并发限额（Rate Limits），保证稳定性。
- **跨模型支持**：系统各个环节应允许自由配置不同的 LLM（如第一阶段使用 GPT-4o，第二阶段使用 DeepSeek）。
